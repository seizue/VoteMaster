@model IEnumerable<PollViewDto>
@using VoteMaster.Services
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    var currentStatus = ViewBag.CurrentStatus ?? "active";
    var statusOptions = ViewBag.StatusOptions ?? new List<string>();
}

<style>
    .polls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .polls-header h3 {
        margin: 0;
        flex: 1;
        min-width: 100px;
    }
    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .filter-buttons .btn {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
    }
    .poll-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .poll-actions .btn {
        white-space: nowrap;
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        flex: 1 1 auto;
        min-width: 60px;
    }
    .poll-actions form {
        display: flex;
        flex: 1 1 auto;
        min-width: 60px;
        margin: 0;
        padding: 0;
    }
    .poll-actions form .btn {
        width: 100%;
        margin: 0;
        padding: 0.375rem 0.75rem;
        white-space: nowrap;
        font-size: 0.875rem;
    }
    @@media (max-width: 576px) {
        .polls-header {
            flex-direction: column;
            align-items: stretch;
        }
        .polls-header h3 {
            order: 1;
            width: 100%;
        }
        .filter-buttons {
            order: 2;
            width: 100%;
        }
        .filter-buttons .btn {
            flex: 1;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .poll-actions {
            gap: 0.3rem;
        }
        .poll-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            min-width: 50px;
        }
        .poll-actions form {
            min-width: 50px;
        }
        .poll-actions form .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    }
    @@media (min-width: 577px) and (max-width: 768px) {
        .poll-actions {
            gap: 0.3rem;
        }
        .poll-actions .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            min-width: 55px;
        }
        .poll-actions form {
            min-width: 55px;
        }
        .poll-actions form .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
    }
    @@media (min-width: 769px) {
        .poll-actions {
            flex-wrap: nowrap;
        }
        .poll-actions .btn {
            flex: 0 1 auto;
            min-width: auto;
        }
        .poll-actions form {
            flex: 0 1 auto;
            min-width: auto;
        }
    }
</style>

<div class="polls-header">
    <h3>Polls</h3>
    <div class="filter-buttons">
        @foreach (var option in statusOptions)
        {
            var isActive = currentStatus.Equals(option, StringComparison.OrdinalIgnoreCase);
            var btnClass = isActive ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-primary";
            <a href="/Admin/Polls?status=@option" class="@btnClass">
                @(char.ToUpper(option[0]) + option.Substring(1))
            </a>
        }
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info text-center py-4">
        <p class="mb-0">No polls found in this category.</p>
    </div>
}
else
{
    <ul class="list-group">
    @foreach (var item in Model) {
        var poll = item.Poll;
        var status = item.Status;
        var statusBadgeClass = status switch 
        {
            "Active" => "badge bg-success",
            "Archived" => "badge bg-secondary",
            "Upcoming" => "badge bg-info",
            _ => "badge bg-light"
        };
        
        <li class="list-group-item" data-poll-id="@poll.Id">
            <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                    <div>
                        <strong>@poll.Title</strong>
                        <span class="@statusBadgeClass">@status</span>
                    </div>
                    <small class="text-muted d-block">@poll.Description</small>
                    <small class="text-muted d-block mt-1">
                        Start: @poll.StartTime.ToString("g") | 
                        End: @poll.EndTime.ToString("g")
                    </small>
                </div>
                <div class="poll-actions">
                    <a class="btn btn-primary" href="/Admin/Polls/Results/@poll.Id">Results</a>
                    <a class="btn btn-info" href="/Admin/Polls/VoterStatus/@poll.Id">Voter Status</a>
                    @if (status != "Archived")
                    {
                        <a class="btn btn-warning" href="/Admin/Polls/Edit/@poll.Id">Edit</a>
                    }
                    @if (status == "Upcoming" || status == "Active")
                    {
                        <form method="post" action="/Admin/Polls/Delete/@poll.Id" onsubmit="return confirm('Are you sure?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    }
                    @if (status == "Archived")
                    {
                        <button type="button" class="btn btn-danger" onclick="showArchiveDeleteModal(@poll.Id, '@poll.Title')">Delete</button>
                    }
                </div>
            </div>
        </li>
    }
    </ul>
}

<!-- Archive Delete Modal -->
<div class="modal fade" id="archiveDeleteModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="archiveDeleteModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archiveDeleteModalTitle">Delete Archived Poll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to delete the archived poll: <strong id="pollTitleModal"></strong></p>
                <p class="text-danger">This action cannot be undone. Please enter your admin credentials to confirm.</p>
                <form id="archiveDeleteForm">
                    <div class="mb-3">
                        <label class="form-label" for="adminUsername">Admin Username</label>
                        <input type="text" class="form-control" id="adminUsername" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="adminPassword">Admin Password</label>
                        <input type="password" class="form-control" id="adminPassword" required />
                    </div>
                    <div id="deleteError" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmArchiveDelete()">Delete Poll</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentArchiveDeleteId = null;

function showArchiveDeleteModal(pollId, pollTitle) {
    currentArchiveDeleteId = pollId;
    document.getElementById('pollTitleModal').textContent = pollTitle;
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('deleteError').classList.add('d-none');
    
    const modal = new bootstrap.Modal(document.getElementById('archiveDeleteModal'));
    modal.show();
}

function confirmArchiveDelete() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const errorDiv = document.getElementById('deleteError');
    
    // Simple credential check (frontend only)
    // In production, this should be validated server-side
    if (username === 'admin' && password === 'admin123') {
        // Delete from frontend only - remove the item from the list
        const item = document.querySelector(`li[data-poll-id="${currentArchiveDeleteId}"]`);
        if (item) {
            item.style.opacity = '0.5';
            setTimeout(() => item.remove(), 300);
        }
        
        // Close the modal
        bootstrap.Modal.getInstance(document.getElementById('archiveDeleteModal')).hide();
        
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show mt-3';
        alert.innerHTML = 'Archived poll deleted successfully (frontend only). <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.querySelector('.container').insertAdjacentElement('afterbegin', alert);
        
        setTimeout(() => alert.remove(), 3000);
    } else {
        errorDiv.classList.remove('d-none');
        errorDiv.textContent = 'Invalid credentials. Please try again.';
    }
}
</script>

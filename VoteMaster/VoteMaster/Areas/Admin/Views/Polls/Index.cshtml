@model IEnumerable<PollViewDto>
@using VoteMaster.Services
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    var currentStatus = ViewBag.CurrentStatus ?? "active";
    var statusOptions = ViewBag.StatusOptions ?? new List<string>();
}

<style>
    .polls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .polls-header h3 {
        margin: 0;
        flex: 1;
        min-width: 100px;
    }
    .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .filter-buttons .btn {
        padding: 0.5rem 1rem;
        font-size: 0.95rem;
    }
    .poll-actions {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
        align-items: center;
    }
    .poll-actions .btn {
        white-space: nowrap;
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        flex: 1 1 auto;
        min-width: 60px;
    }
    .poll-actions form {
        display: flex;
        flex: 1 1 auto;
        min-width: 60px;
        margin: 0;
        padding: 0;
    }
    .poll-actions form .btn {
        width: 100%;
        margin: 0;
        padding: 0.375rem 0.75rem;
        white-space: nowrap;
        font-size: 0.875rem;
    }
    @@media (max-width: 576px) {
        .polls-header {
            flex-direction: column;
            align-items: stretch;
        }
        .polls-header h3 {
            order: 1;
            width: 100%;
        }
        .filter-buttons {
            order: 2;
            width: 100%;
        }
        .filter-buttons .btn {
            flex: 1;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        .poll-actions {
            gap: 0.3rem;
        }
        .poll-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            min-width: 50px;
        }
        .poll-actions form {
            min-width: 50px;
        }
        .poll-actions form .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
        }
    }
    @@media (min-width: 577px) and (max-width: 768px) {
        .poll-actions {
            gap: 0.3rem;
        }
        .poll-actions .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
            min-width: 55px;
        }
        .poll-actions form {
            min-width: 55px;
        }
        .poll-actions form .btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
    }
    @@media (min-width: 769px) {
        .poll-actions {
            flex-wrap: nowrap;
        }
        .poll-actions .btn {
            flex: 0 1 auto;
            min-width: auto;
        }
        .poll-actions form {
            flex: 0 1 auto;
            min-width: auto;
        }
    }
</style>

<div class="polls-header">
    <h3>Polls</h3>
    <div class="filter-buttons">
        @foreach (var option in statusOptions)
        {
            var isActive = currentStatus.Equals(option, StringComparison.OrdinalIgnoreCase);
            var btnClass = isActive ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-primary";
            <a href="/Admin/Polls?status=@option" class="@btnClass">
                @(char.ToUpper(option[0]) + option.Substring(1))
            </a>
        }
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-secondary text-center py-4">
        <i class="bi bi-info-circle me-2"></i>
        <span>No polls found in this category.</span>
    </div>
}
else
{
    <ul class="list-group" id="pollsList">
    @foreach (var item in Model) {
        var poll = item.Poll;
        var status = item.Status;
        var statusBadgeClass = status switch 
        {
            "Active" => "badge bg-success",
            "Archived" => "badge bg-secondary",
            "Upcoming" => "badge bg-info",
            _ => "badge bg-light"
        };
        
        <li class="list-group-item poll-item" data-poll-id="@poll.Id">
            <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="flex-grow-1">
                    <div>
                        <strong>@poll.Title</strong>
                        <span class="@statusBadgeClass">@status</span>
                    </div>
                    <small class="text-muted d-block">@poll.Description</small>
                    <small class="text-muted d-block mt-1">
                        Start: @poll.StartTime.ToString("g") | 
                        End: @poll.EndTime.ToString("g")
                    </small>
                </div>
                <div class="poll-actions">
                    <a class="btn btn-primary" href="/Admin/Polls/Results/@poll.Id">Results</a>
                    <a class="btn btn-info" href="/Admin/Polls/VoterStatus/@poll.Id">Voter Status</a>
                    @if (status != "Archived")
                    {
                        <a class="btn btn-warning" href="/Admin/Polls/Edit/@poll.Id">Edit</a>
                    }
                    @if (status == "Upcoming" || status == "Active")
                    {
                        <form method="post" action="/Admin/Polls/Delete/@poll.Id" onsubmit="return confirm('Are you sure?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    }
                    @if (status == "Archived")
                    {
                        <button type="button" class="btn btn-danger" onclick="showArchiveDeleteModal(@poll.Id, '@poll.Title')">Delete</button>
                    }
                </div>
            </div>
        </li>
    }
    </ul>
    
    <!-- Pagination -->
    <div class="pagination-container mt-4">
        <div class="pagination-info">
            Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of <span id="totalItems">@Model.Count()</span> polls
        </div>
        <nav>
            <ul class="pagination" id="pagination">
                <!-- Pagination will be generated by JavaScript -->
            </ul>
        </nav>
    </div>
}

<!-- Archive Delete Modal -->
<div class="modal fade" id="archiveDeleteModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="archiveDeleteModalTitle">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="archiveDeleteModalTitle">Delete Archived Poll</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to delete the archived poll: <strong id="pollTitleModal"></strong></p>
                <p class="text-danger">This action cannot be undone. Please enter your admin credentials to confirm.</p>
                <form id="archiveDeleteForm">
                    <div class="mb-3">
                        <label class="form-label" for="adminUsername">Admin Username</label>
                        <input type="text" class="form-control" id="adminUsername" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="adminPassword">Admin Password</label>
                        <input type="password" class="form-control" id="adminPassword" required />
                    </div>
                    <div id="deleteError" class="alert alert-danger d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmArchiveDelete()">Delete Poll</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentArchiveDeleteId = null;
let currentPage = 1;
let itemsPerPage = 10;
let allPolls = [];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const pollItems = document.querySelectorAll('.poll-item');
    allPolls = Array.from(pollItems);
    
    if (allPolls.length > 0) {
        updatePagination();
        displayPage(1);
    }
});

function displayPage(page) {
    currentPage = page;
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    
    // Hide all items
    allPolls.forEach(poll => {
        poll.style.display = 'none';
    });
    
    // Show items for current page
    const itemsToShow = allPolls.slice(start, end);
    itemsToShow.forEach(poll => {
        poll.style.display = '';
    });
    
    // Update pagination info
    document.getElementById('showingStart').textContent = allPolls.length > 0 ? start + 1 : 0;
    document.getElementById('showingEnd').textContent = Math.min(end, allPolls.length);
    document.getElementById('totalItems').textContent = allPolls.length;
    
    updatePaginationButtons();
}

function updatePagination() {
    const totalPages = Math.ceil(allPolls.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;"><i class="bi bi-chevron-left"></i></a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    const maxVisible = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
        pagination.appendChild(li);
        
        if (startPage > 2) {
            const dots = document.createElement('li');
            dots.className = 'page-item disabled';
            dots.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(dots);
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const dots = document.createElement('li');
            dots.className = 'page-item disabled';
            dots.innerHTML = `<span class="page-link">...</span>`;
            pagination.appendChild(dots);
        }
        
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;"><i class="bi bi-chevron-right"></i></a>`;
    pagination.appendChild(nextLi);
}

function updatePaginationButtons() {
    updatePagination();
}

function changePage(page) {
    const totalPages = Math.ceil(allPolls.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    displayPage(page);
}

function showArchiveDeleteModal(pollId, pollTitle) {
    currentArchiveDeleteId = pollId;
    document.getElementById('pollTitleModal').textContent = pollTitle;
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('deleteError').classList.add('d-none');
    
    const modal = new bootstrap.Modal(document.getElementById('archiveDeleteModal'));
    modal.show();
}

function confirmArchiveDelete() {
    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const errorDiv = document.getElementById('deleteError');
    
    if (username === 'admin' && password === 'admin123') {
        const item = document.querySelector(`li[data-poll-id="${currentArchiveDeleteId}"]`);
        if (item) {
            item.style.opacity = '0.5';
            setTimeout(() => {
                item.remove();
                
                // Update polls array
                allPolls = allPolls.filter(p => p.dataset.pollId !== currentArchiveDeleteId.toString());
                
                updatePagination();
                displayPage(currentPage);
            }, 300);
        }
        
        bootstrap.Modal.getInstance(document.getElementById('archiveDeleteModal')).hide();
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show mt-3';
        alert.innerHTML = 'Archived poll deleted successfully (frontend only). <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.querySelector('.container').insertAdjacentElement('afterbegin', alert);
        
        setTimeout(() => alert.remove(), 3000);
    } else {
        errorDiv.classList.remove('d-none');
        errorDiv.textContent = 'Invalid credentials. Please try again.';
    }
}
</script>

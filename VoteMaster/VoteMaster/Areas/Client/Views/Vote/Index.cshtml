@model VoteMaster.Models.Poll
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    bool hasVoted = (bool?)ViewBag.HasVoted ?? false;
    int voteCount = (int?)ViewBag.VoteCount ?? 0;
    int maxVotes = (int?)ViewBag.MaxVotes ?? 0;
    var userVotes = (List<int>?)ViewBag.UserVotes ?? new List<int>();
    bool showResults = (bool?)ViewBag.ShowResults ?? false;
    string pollStatus = (string?)ViewBag.PollStatus ?? "Active";
    var sortedOptions = Model.Options.OrderByDescending(o => o.Votes.Count).ToList();
    var totalVotes = sortedOptions.Sum(o => o.Votes.Count);
}

<div class="vote-page">
    <!-- Poll Header Card -->
    <div class="vote-header-card">
        <h1>@Model.Title</h1>
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p>@Model.Description</p>
        }
        @if (pollStatus == "Archived")
        {
            <span class="badge bg-secondary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                <i class="bi bi-lock-fill me-2"></i>Poll Closed
            </span>
        }
    </div>

    @if (hasVoted && voteCount >= maxVotes)
    {
        <div class="alert alert-secondary">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Voting Complete!</strong> You have already cast @voteCount vote(s) for this poll.
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            @TempData["Success"]
        </div>
    }

    @if (showResults)
    {
        <!-- Results View -->
        <div class="results-section">
            <h4 class="mb-3">
                <i class="bi bi-bar-chart-fill me-2"></i>Poll Results
            </h4>
            
            <div class="results-grid">
                @foreach (var option in sortedOptions)
                {
                    var votes = option.Votes.Count;
                    var percentage = totalVotes > 0 ? (votes * 100.0 / totalVotes) : 0;
                    var isUserVote = userVotes.Contains(option.Id);
                    
                    <div class="result-card @(isUserVote ? "user-voted" : "")">
                        <div class="result-header">
                            <div class="result-title">
                                @option.Text
                                @if (isUserVote)
                                {
                                    <span class="badge bg-primary ms-2">
                                        <i class="bi bi-check-circle-fill"></i> Your Vote
                                    </span>
                                }
                            </div>
                            <div class="result-count">@votes vote@(votes != 1 ? "s" : "")</div>
                        </div>
                        <div class="result-bar-container">
                            <div class="result-bar" style="width: @percentage.ToString("F1")%"></div>
                        </div>
                        <div class="result-percentage">@percentage.ToString("F1")%</div>
                    </div>
                }
            </div>
            
            <div class="results-summary">
                <i class="bi bi-people-fill me-2"></i>
                <strong>Total Votes:</strong> @totalVotes
            </div>
        </div>
    }
    else
    {
        <!-- Voting Form -->
        <form method="post" action="@Url.Action("Cast", "Vote", new { area = "Client" })" id="voteForm">
            <input type="hidden" name="pollId" value="@Model.Id" />
            @Html.AntiForgeryToken()
            
            @if (TempData["Error"] != null) 
            { 
                <div class="alert alert-danger">@TempData["Error"]</div> 
            }

        <div class="vote-options-grid">
            @foreach (var option in sortedOptions)
            {
                var votes = option.Votes.Count;
                var isDisabled = hasVoted && voteCount >= maxVotes;
                
                <div class="vote-option-card @(isDisabled ? "disabled" : "")">
                    <input type="checkbox" name="optionIds" value="@option.Id" id="option-@option.Id" class="vote-checkbox" @(isDisabled ? "disabled" : "") />
                    <label for="option-@option.Id" class="vote-option-label">
                        <div class="vote-option-header">
                            <div class="vote-option-title">@option.Text</div>
                            <div class="vote-check-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                        </div>
                        <div class="vote-option-footer">
                            <div class="vote-count-badge">
                                <i class="bi bi-people-fill"></i>
                                <span>@votes</span>
                            </div>
                        </div>
                    </label>
                </div>
            }
        </div>

        <div class="vote-submit-container">
            <div class="vote-hint" id="voteHint"></div>
            <div class="vote-buttons">
                <button type="submit" class="btn btn-primary btn-lg" id="submitButton" @(hasVoted && voteCount >= maxVotes ? "disabled" : "")>
                    <i class="bi bi-check2-circle me-2"></i>@(hasVoted && voteCount >= maxVotes ? "Voting Complete" : "Submit Your Votes")
                </button>
                @if (hasVoted && voteCount >= maxVotes && pollStatus != "Archived")
                {
                    <button type="button" class="btn btn-dark btn-lg" onclick="if(confirm('Are you sure you want to reset your votes? This will remove all your current votes for this poll.')) { document.getElementById('resetForm').submit(); }">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Reset My Votes
                    </button>
                }
            </div>
        </div>
    </form>
    }
    
    @if (hasVoted && voteCount >= maxVotes && pollStatus != "Archived")
    {
        <form method="post" action="@Url.Action("Reset", "Vote", new { area = "Client" })" id="resetForm" style="display: none;">
            <input type="hidden" name="pollId" value="@Model.Id" />
            @Html.AntiForgeryToken()
        </form>
    }
</div>

@section Scripts {
<script>
  (function(){
    const min = @Model.MinVotesPerVoter;
    const max = @Model.MaxVotesPerVoter;
    const submit = document.getElementById('submitButton');
    const hint = document.getElementById('voteHint');
    const checkboxes = document.querySelectorAll('.vote-checkbox');
    const cards = document.querySelectorAll('.vote-option-card');

    function updateState() {
      const checked = document.querySelectorAll('input[name="optionIds"]:checked').length;
      
      // Update card states
      checkboxes.forEach((checkbox, index) => {
        if (checkbox.checked) {
          cards[index].classList.add('selected');
        } else {
          cards[index].classList.remove('selected');
        }
      });
      
      // Update submit button
      if (checked < min) {
        submit.disabled = true;
        hint.textContent = `Please select at least ${min} option${min > 1 ? 's' : ''}.`;
        hint.style.display = 'block';
      } else if (checked > max) {
        submit.disabled = true;
        hint.textContent = `Maximum ${max} option${max > 1 ? 's' : ''} allowed.`;
        hint.style.display = 'block';
      } else {
        submit.disabled = false;
        hint.style.display = 'none';
      }
    }

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateState);
    });

    updateState();
  })();
</script>
}
